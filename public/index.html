<title>OFBiz Minilang to Java</title>

<style>
    body {
        background-color: #2f3129;
        margin: 0;
        padding: 0;
    }

    #container {
        height: 100vh;
        width: 100vw;
        display: grid;
        grid-template-areas:
            "input output"
            "controls controls";
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr auto;
    }

    #input {
        width: 100%;
        height: 100%;
        grid-area: input;
    }

    #output {
        width: 100%;
        height: 100%;
        grid-area: output;
    }

    #controls {
        grid-area: controls;
        color: white;
        font-family: "Courier New", Courier, monospace;
        padding: 10px;
        justify-content: center;
        align-items: center;
        display: flex;
        gap: 10px;
    }

    #controls input[type="text"] {
        width: 35ch;
        padding: 5px;
    }
    #controls #submit {
        padding: 8px 20px;
    }
    #controls #splitSizes {
        width: 4em;
    }
</style>

<div id="container">
    <div id="input"></div>
    <div id="output"></div>
    <div id="controls">
        <input
            type="range"
            min="-1"
            max="1"
            step="1"
            value="0"
            id="splitSizes"
        />
        <input type="text" id="className" placeholder="Class Name" />
        <input type="text" id="packageName" placeholder="Package Name" />
        <label><input type="radio" name="mode" value="SERVICE" />Service</label>
        <label><input type="radio" name="mode" value="EVENT" />Event</label>
        <label
            ><input
                type="radio"
                name="mode"
                value="GENERIC"
                checked
            />Util</label
        >
        <button id="submit">Convert</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
<script>
    window.addEventListener("load", () => {
        const $input = document.querySelector("#input");
        const $output = document.querySelector("#output");
        const $className = document.querySelector("#className");
        const $packageName = document.querySelector("#packageName");

        const options = {
            selectionStyle: "text",
            wrap: true,
            theme: "ace/theme/monokai",
            fontSize: "15px",
        };

        ace.edit("input", {
            ...options,
            mode: "ace/mode/xml",
        });

        ace.edit("output", {
            ...options,
            mode: "ace/mode/java",
        });

        document.querySelector("#submit").addEventListener("click", () => {
            const $methodMode = document.querySelector(
                "input[name='mode']:checked"
            );
            document.querySelector("#submit").disabled = "disabled";
            const input = ace.edit("input").getSession().getValue();

            localStorage.setItem("editor.inputText", input);
            localStorage.setItem("editor.className", $className.value);
            localStorage.setItem("editor.packageName", $packageName.value);
            localStorage.setItem("editor.methodMode", $methodMode.value);

            fetch("/convert", {
                method: "post",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    input,
                    className: $className.value,
                    packageName: $packageName.value,
                    methodMode: $methodMode.value,
                }),
            })
                .then((res) => {
                    return res.json();
                })
                .then((data) => {
                    if (data && data.output) {
                        ace.edit("output").getSession().setValue(data.output);
                    } else {
                        ace.edit("output").getSession().setValue(data);
                    }
                })
                .catch((err) => {
                    console.error(err);
                    ace.edit("output").getSession().setValue(err.toString());
                })
                .finally(() => {
                    document.querySelector("#submit").disabled = undefined;
                });
        });

        ace.edit("input")
            .getSession()
            .setValue(localStorage.getItem("editor.inputText") ?? "");
        $className.value = localStorage.getItem("editor.className") ?? "";
        $packageName.value = localStorage.getItem("editor.packageName") ?? "";
        const methodMode = document.querySelector(
            `input[name="mode"][value="${localStorage.getItem(
                "editor.methodMode"
            )}"]`
        );
        if (methodMode) {
            methodMode.checked = "checked";
        }

        const $splitSizes = document.querySelector("#controls #splitSizes");
        $splitSizes.addEventListener("change", (e) => {
            const $container = document.querySelector("#container");
            const sizeMap = {
                [-1]: "10em 1fr",
                [0]: "1fr 1fr",
                [1]: "1fr 10em",
            };
            $container.style.gridTemplateColumns = sizeMap[$splitSizes.value];
            ["input", "output"].forEach((el) => {
                const session = ace.edit(el).getSession();
                session.setWrapLimitRange(
                    Math.max(session.getScreenLength(), 10),
                    null
                );
            });
        });
    });
</script>
