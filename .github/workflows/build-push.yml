name: BE Docker Image CI

on:
  pull_request_target:
    types:
      - opened
  push:
      branches:
        - 'master'
      paths:
        - 'api/**'
        - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      dockerImage: eu.gcr.io/personalweb-279207/minilang-to-java
    steps:
    - uses: actions/checkout@v2
    
    - name: Docker Build
      run: docker build -f ./Dockerfile -t "${{ env.dockerImage }}:build-${{ github.run_id }}" -t "${{ env.dockerImage }}:latest" .
    
    - name: Docker Login
      if: github.ref == 'refs/heads/master'
      env:
        DOCKER_PASSWORD: "${{ secrets.DOCKER_PASSWORD }}"
      run: echo $DOCKER_PASSWORD | docker login -u _json_key --password-stdin https://eu.gcr.io
      
    - name: Docker Push
      if: github.ref == 'refs/heads/master'
      run: docker image push --all-tags "${{ env.dockerImage }}"